<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Interactive Globe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        /* Setup for full-screen canvas and responsive design */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #000;
        }

        #globe-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            cursor: grab;
        }
        
        #globe-container.grabbing {
            cursor: grabbing;
        }

        /* Overlay for game UI elements */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Allows mouse/touch events to pass through to the canvas */
        }
        
        /* Elements that need to be clickable must have pointer-events enabled */
        .clickable {
            pointer-events: auto;
        }
        
        canvas {
            touch-action: none; /* Prevents default mobile scrolling behavior */
        }
        
        /* Basic animation for scene transitions */
        .scene-image-animation {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Shake animation for incorrect answers */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* --- Flip Card Animation --- */
        .flip-card {
            background-color: transparent;
            perspective: 1000px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card-inner.is-flipped {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 0.5rem; /* rounded-lg */
        }
        .flip-card-back {
            background-color: #2d3748; /* gray-800 */
            color: white;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
        }
        
        /* Pop-up animation */
        @keyframes popup {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .animate-popup {
            animation: popup 0.3s ease-out forwards;
        }

    </style>
</head>
<body>

    <!-- Three.js renders the 3D scene into this container -->
    <div id="globe-container"></div>

    <!-- UI Overlay for context -->
    <div id="main-ui" class="ui-overlay p-6 flex flex-col items-center justify-start">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white text-shadow-lg tracking-wider">GTA</h1>
        <p class="text-lg text-white mt-2 p-2 rounded-lg bg-black bg-opacity-50">Global Translation Adventures</p>
        <p id="instruction-text" class="absolute bottom-8 left-1/2 -translate-x-1/2 text-sm text-yellow-400 p-2 rounded-lg bg-black bg-opacity-50 whitespace-nowrap">
            Drag the globe to explore and click a marker to select a destination.
        </p>
        <div id="location-info" class="hidden absolute bottom-16 left-1/2 -translate-x-1/2 bg-black bg-opacity-70 p-8 rounded-2xl text-center shadow-2xl flex flex-col items-center gap-4 w-80">
            <h2 id="location-name" class="text-5xl font-bold text-white">Location</h2>
            <button id="start-journey-btn" class="clickable bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition-transform transform hover:scale-105">Start Your Journey</button>
        </div>
        <div id="loading-message" class="mt-8 p-4 bg-blue-700 rounded-xl text-white font-semibold">Loading Realistic 3D Globe...</div>
    </div>

    <!-- Adventure List Page -->
    <div id="level-page" class="hidden absolute top-0 left-0 w-full h-full bg-gray-900 z-20 flex flex-col justify-center items-center text-white p-8 overflow-y-auto">
        <h1 id="level-title" class="text-6xl font-extrabold mb-4 text-center">Welcome!</h1>
        <p class="text-2xl mb-8">Choose your adventure below:</p>
        <div id="adventure-list" class="w-full max-w-2xl space-y-4"></div>
        <button id="back-to-globe-btn" class="clickable bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition-transform transform hover:scale-105 mt-12">Back to Globe</button>
    </div>

    <!-- Scene Page -->
    <div id="scene-page" class="hidden absolute top-0 left-0 w-full h-full bg-gray-800 z-30 flex flex-col items-center text-white p-4 sm:p-6 overflow-y-auto">
        <div class="w-full max-w-3xl">
            <button id="back-to-adventures-btn" class="clickable flex items-center gap-2 text-lg hover:text-yellow-400 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                Back to Adventures
            </button>
            <h1 id="scene-adventure-title" class="text-3xl font-bold">Adventure Title</h1>
            <p id="scene-prompt" class="text-lg mt-1 mb-4 text-gray-300">Prompt text goes here.</p>
        </div>
        
        <!-- Scene Image Flip Container -->
        <div class="w-full max-w-3xl aspect-video bg-transparent my-4 flex-shrink-0 flip-card">
             <div id="flip-card-inner" class="flip-card-inner">
                <div class="flip-card-front shadow-lg">
                    <img id="scene-image" src="https://placehold.co/1280x720/000000/FFFFFF?text=Scene" class="w-full h-full object-cover rounded-lg">
                </div>
                <div class="flip-card-back shadow-lg">
                    <h2 class="text-2xl font-bold">Phrase Notes</h2>
                    <p class="mt-4 text-lg">Detailed notes about the grammar and context will appear here!</p>
                </div>
            </div>
        </div>
        
        <!-- Options -->
        <div id="scene-options" class="w-full max-w-3xl mt-4 grid grid-cols-1 md:grid-cols-3 gap-4"></div>

        <!-- Action Buttons (Continue/Review) -->
        <div id="scene-actions" class="w-full max-w-3xl mt-6 flex flex-col sm:flex-row gap-4 hidden">
            <button id="review-btn" class="clickable bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg text-lg w-full">Review Phrase Details</button>
            <button id="continue-btn" class="clickable bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg w-full">Continue Touring</button>
        </div>
    </div>

    <!-- Badge Unlocked Modal -->
    <div id="badge-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black bg-opacity-70 z-40 flex justify-center items-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl text-center shadow-2xl flex flex-col items-center gap-4 w-full max-w-md transform scale-95 opacity-0 animate-popup">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" clip-rule="evenodd" />
            </svg>
            <h2 class="text-3xl font-bold">You earned a new badge!</h2>
            <p id="badge-name" class="text-xl text-yellow-400"></p>
            <div class="flex flex-col w-full gap-3 mt-4">
                 <button id="badge-continue-btn" class="clickable bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg w-full">Continue</button>
                 <button id="badge-progress-btn" class="clickable bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg text-lg w-full">View Progress Tracker</button>
            </div>
        </div>
    </div>
    
    <!-- Progress Tracker Page -->
    <div id="progress-page" class="hidden absolute top-0 left-0 w-full h-full bg-gray-900 z-50 flex flex-col items-center text-white p-8 overflow-y-auto">
        <button id="back-from-progress-btn" class="clickable absolute top-6 left-6 flex items-center gap-2 text-lg hover:text-yellow-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            Back
        </button>
        <h1 class="text-5xl font-extrabold mb-8">Progress Tracker</h1>
        
        <div class="mb-8 text-center">
            <p class="text-lg text-gray-400">Current Rank</p>
            <h2 id="current-rank" class="text-3xl font-bold text-yellow-400">Novice Traveler</h2>
        </div>

        <div id="badge-grid" class="w-full max-w-4xl grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
            <!-- Badges will be dynamically inserted here -->
        </div>
    </div>


    <script>
        let scene, camera, renderer, globe, stars;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        const container = document.getElementById('globe-container');
        const loadingMessage = document.getElementById('loading-message');

        // UI Element references
        const mainUI = document.getElementById('main-ui');
        const locationInfo = document.getElementById('location-info');
        const levelPage = document.getElementById('level-page');
        const scenePage = document.getElementById('scene-page');
        const progressPage = document.getElementById('progress-page');
        const instructionText = document.getElementById('instruction-text');
        const locationNameUI = document.getElementById('location-name');
        const levelTitleUI = document.getElementById('level-title');
        const adventureListUI = document.getElementById('adventure-list');
        const sceneAdventureTitleUI = document.getElementById('scene-adventure-title');
        const scenePromptUI = document.getElementById('scene-prompt');
        const sceneImageUI = document.getElementById('scene-image');
        const sceneOptionsUI = document.getElementById('scene-options');
        const sceneActionsUI = document.getElementById('scene-actions');
        const continueBtn = document.getElementById('continue-btn');
        const reviewBtn = document.getElementById('review-btn');
        const flipCardInner = document.getElementById('flip-card-inner');
        const badgeModal = document.getElementById('badge-modal');
        const badgeNameUI = document.getElementById('badge-name');

        // --- Interactivity State ---
        let raycaster, mouse, clickableObjects = [];
        let isZooming = false;
        let isZoomedIn = false;
        let cameraTargetPosition = new THREE.Vector3();
        const originalCameraPosition = new THREE.Vector3(0, 0, 10);
        let selectedLocationName = '';
        let selectedAdventureIndex = 0;
        let currentSceneIndex = 0;

        // --- Game State & Content ---
        let gameState;
        const countryOrder = ['Japan', 'S. Korea', 'Mexico', 'Italy', 'Germany', 'France'];
        
        const ranks = [
            "Novice Traveler", 
            "Regional Explorer", 
            "Continental Voyager", 
            "Seasoned Globetrotter", 
            "World Wanderer", 
            "Master Linguist",
            "Global Ambassador"
        ];
        
        const adventures = {
            'Japan': [{
                title: 'Arrived in Tokyo',
                badge: 'Tokyo Explorer',
                scenes: [{
                    prompt: 'You just landed! How do you ask "Where is the baggage claim?"',
                    image: 'https://placehold.co/1280x720/334155/FFFFFF?text=Tokyo+Airport',
                    options: [ { text: 'トイレはどこですか？ (Toire wa doko desu ka?)', translation: 'Where is the restroom?', correct: false }, { text: '手荷物受取所はどこですか？ (Tenimotsu uketorijo wa doko desu ka?)', translation: 'Where is the baggage claim?', correct: true }, { text: 'これはいくらですか？ (Kore wa ikura desu ka?)', translation: 'How much is this?', correct: false } ]
                }, {
                    prompt: 'You have your bags. How do you ask "Which train goes to Shibuya?"',
                    image: 'https://placehold.co/1280x720/553341/FFFFFF?text=Train+Station',
                    options: [ { text: '渋谷へ行く電車はどれですか？ (Shibuya e iku densha wa dore desu ka?)', translation: 'Which train goes to Shibuya?', correct: true }, { text: '助けてください！ (Tasukete kudasai!)', translation: 'Please help!', correct: false }, { text: 'もう一度お願いします (Mōichido onegaishimasu)', translation: 'Once more, please.', correct: false } ]
                }, {
                    prompt: 'Time for lunch! How do you tell the chef "This is delicious!"?',
                    image: 'https://placehold.co/1280x720/415533/FFFFFF?text=Ramen+Shop',
                    options: [ { text: 'お勘定をお願いします (Okanjō o onegaishimasu)', translation: 'Check, please.', correct: false }, { text: 'これは美味しいです！ (Kore wa oishī desu!)', translation: 'This is delicious!', correct: true }, { text: 'はじめまして (Hajimemashite)', translation: 'Nice to meet you.', correct: false } ]
                }, {
                    prompt: 'You need to check into your hotel. How do you say "I have a reservation"?',
                    image: 'https://placehold.co/1280x720/6b7280/FFFFFF?text=Hotel+Lobby',
                    options: [ { text: '予約があります (Yoyaku ga arimasu)', translation: 'I have a reservation.', correct: true }, { text: 'メニューをください (Menyū o kudasai)', translation: 'Can I have the menu?', correct: false }, { text: 'さようなら (Sayōnara)', translation: 'Goodbye.', correct: false } ]
                }, {
                    prompt: 'You had a great day. How do you say a simple "Thank you"?',
                    image: 'https://placehold.co/1280x720/1d4ed8/FFFFFF?text=Tokyo+Night',
                    options: [ { text: 'すみません (Sumimasen)', translation: 'Excuse me / Sorry.', correct: false }, { text: 'お元気ですか (Ogenki desu ka)', translation: 'How are you?', correct: false }, { text: 'ありがとうございます (Arigatō gozaimasu)', translation: 'Thank you.', correct: true } ]
                }]
            },
            { title: 'Hike the Sacred Trails of Mt. Fuji', scenes: [], badge: 'Fuji Mountaineer' },
            { title: 'Discover the Ancient Temples of Kyoto', scenes: [], badge: 'Kyoto Historian' },
            { title: 'Taste the Flavors of Osaka\'s Kitchen', scenes: [], badge: 'Osaka Foodie' },
            { title: 'Relax in the Hot Springs of Hakone', scenes: [], badge: 'Hakone Relaxer' }
            ],
            'S. Korea': [
                { title: 'Explore Seoul Palace', scenes: [], badge: 'Seoul Royalist' },
                { title: 'Hike Bukhansan Park', scenes: [], badge: 'Bukhansan Peak' },
                { title: 'Visit the DMZ', scenes: [], badge: 'DMZ Witness' },
                { title: 'Nightlife in Gangnam', scenes: [], badge: 'Gangnam Stylist' },
                { title: 'Myeongdong Market', scenes: [], badge: 'Myeongdong Taster' }
            ],
            'Mexico': [
                { title: 'Chichen Itza Ruins', scenes: [], badge: 'Mayan Explorer' },
                { title: 'Swim in Cenotes', scenes: [], badge: 'Cenote Diver' },
                { title: 'Mexico City Markets', scenes: [], badge: 'Market Navigator' },
                { title: 'Relax in Cancun', scenes: [], badge: 'Cancun Cruiser' },
                { title: 'Taste Street Tacos', scenes: [], badge: 'Taco Connoisseur' }
            ],
            'Italy': [
                { title: 'Explore the Colosseum', scenes: [], badge: 'Roman Gladiator' },
                { title: 'Venice Canal Tour', scenes: [], badge: 'Venetian Voyager' },
                { title: 'Discover Florence\'s Art', scenes: [], badge: 'Renaissance Scholar' },
                { title: 'Taste Tuscan Wine', scenes: [], badge: 'Tuscan Sommelier' },
                { title: 'Hike the Amalfi Coast', scenes: [], badge: 'Amalfi Adventurer' }
            ],
            'Germany': [
                { title: 'Visit Brandenburg Gate', scenes: [], badge: 'Berlin Historian' },
                { title: 'Explore Neuschwanstein Castle', scenes: [], badge: 'Castle Fantasist' },
                { title: 'Oktoberfest Experience', scenes: [], badge: 'Oktoberfest Pro' },
                { title: 'Drive the Autobahn', scenes: [], badge: 'Autobahn Ace' },
                { title: 'Discover the Black Forest', scenes: [], badge: 'Black Forest Wanderer' }
            ],
            'France': [
                { title: 'Ascend the Eiffel Tower', scenes: [], badge: 'Parisian Pathfinder' },
                { title: 'Explore the Louvre Museum', scenes: [], badge: 'Louvre Connoisseur' },
                { title: 'Taste Champagne', scenes: [], badge: 'Champagne Expert' },
                { title: 'Relax on the French Riviera', scenes: [], badge: 'Riviera Relaxer' },
                { title: 'Visit Mont Saint-Michel', scenes: [], badge: 'Abbey Explorer' }
            ]
        };
        
        // --- Setup Functions ---
        function initializeGameState() {
            gameState = { 
                unlockedCountries: ['Japan'], 
                unlockedAdventures: { 'Japan': 1 }, 
                completedAdventures: { 'Japan': [], 'S. Korea': [], 'Mexico': [], 'Italy': [], 'Germany': [], 'France': [] },
                badges: [],
                sceneProgress: {'Japan-0': 0} 
            }; 
        }
        function createStars() { const g = new THREE.BufferGeometry(); const m = new THREE.PointsMaterial({ color: 0xffffff, size: 0.02 }); const v = []; for (let i = 0; i < 10000; i++) { const x = (Math.random() - 0.5) * 2000; const y = (Math.random() - 0.5) * 2000; const z = (Math.random() - 0.5) * 2000; if (Math.sqrt(x*x+y*y+z*z) > 100) v.push(x, y, z); } g.setAttribute('position', new THREE.Float32BufferAttribute(v, 3)); stars = new THREE.Points(g, m); scene.add(stars); }
        function createAtmosphere() { const g = new THREE.SphereGeometry(3.1, 64, 64); const m = new THREE.ShaderMaterial({ vertexShader: `varying vec3 vN; void main() { vN = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`, fragmentShader: `varying vec3 vN; void main() { float i = pow(0.6 - dot(vN, vec3(0, 0, 1.0)), 2.0); gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * i; }`, blending: THREE.AdditiveBlending, side: THREE.BackSide }); const a = new THREE.Mesh(g, m); a.scale.set(1.1, 1.1, 1.1); scene.add(a); }
        function latLonToVector3(lat, lon, r) { const phi = (90 - lat) * (Math.PI / 180); const theta = (lon + 180) * (Math.PI / 180); return new THREE.Vector3(-(r * Math.sin(phi) * Math.cos(theta)), r * Math.cos(phi), r * Math.sin(phi) * Math.sin(theta)); }
        function createCityMarkers() { const locs = [ { name: 'Japan', lat: 35.6895, lon: 139.6917 }, { name: 'France', lat: 48.8566, lon: 2.3522 }, { name: 'Italy', lat: 41.9028, lon: 12.4964 }, { name: 'Mexico', lat: 19.4326, lon: -99.1332 }, { name: 'Germany', lat: 52.5200, lon: 13.4050 }, { name: 'S. Korea', lat: 37.5665, lon: 126.9780 } ]; const g = new THREE.SphereGeometry(0.08, 16, 16); const uM = new THREE.MeshBasicMaterial({ color: 0xff0000 }); const lM = new THREE.MeshBasicMaterial({ color: 0x888888 }); locs.forEach(l => { const isU = gameState.unlockedCountries.includes(l.name); const m = new THREE.Mesh(g, isU ? uM : lM); m.position.copy(latLonToVector3(l.lat, l.lon, 3)); m.name = `${l.name}Marker`; m.userData = { locationName: l.name, isUnlocked: isU }; if (globe) globe.add(m); clickableObjects.push(m); }); }
        function updateMarkers() { const uM = new THREE.MeshBasicMaterial({ color: 0xff0000 }); const lM = new THREE.MeshBasicMaterial({ color: 0x888888 }); clickableObjects.forEach(m => { const isU = gameState.unlockedCountries.includes(m.userData.locationName); m.material = isU ? uM : lM; m.userData.isUnlocked = isU; }); }

        // --- Main Initialization ---
        function init() {
            initializeGameState();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.copy(originalCameraPosition);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            const textureLoader = new THREE.TextureLoader();
            textureLoader.load('https://unpkg.com/three-globe@2.27.2/example/img/earth-dark.jpg', (earthTexture) => {
                const geometry = new THREE.SphereGeometry(3, 64, 64);
                const material = new THREE.MeshPhongMaterial({ map: earthTexture, specular: 0x333333, shininess: 10 });
                globe = new THREE.Mesh(geometry, material);
                scene.add(globe);
                createCityMarkers();
                loadingMessage.style.display = 'none';
            });

            createStars(); createAtmosphere();
            scene.add(new THREE.AmbientLight(0xCCCCCC));
            const directionalLight = new THREE.DirectionalLight(0xFFFFFF, 1.5);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            addEventListeners();
        }
        
        function addEventListeners() {
            renderer.domElement.addEventListener('mousedown', onPointerStart);
            renderer.domElement.addEventListener('mousemove', onPointerMove);
            renderer.domElement.addEventListener('mouseup', onPointerEnd);
            renderer.domElement.addEventListener('click', onObjectClick);
            window.addEventListener('resize', onWindowResize);
            document.getElementById('start-journey-btn').addEventListener('click', showAdventureList);
            document.getElementById('back-to-globe-btn').addEventListener('click', returnToGlobe);
            document.getElementById('back-to-adventures-btn').addEventListener('click', returnToAdventureList);
            continueBtn.addEventListener('click', continueToNextScene);
            reviewBtn.addEventListener('click', () => {
                flipCardInner.classList.toggle('is-flipped');
            });
            document.getElementById('badge-continue-btn').addEventListener('click', () => {
                badgeModal.classList.add('hidden');
                returnToAdventureList();
            });
            document.getElementById('badge-progress-btn').addEventListener('click', () => {
                 showProgressTracker();
            });
            document.getElementById('back-from-progress-btn').addEventListener('click', () => {
                progressPage.classList.add('hidden');
                showAdventureList();
            });
        }

        // --- Page Navigation & UI Display ---
        function showAdventureList() {
            levelTitleUI.textContent = `Welcome to ${selectedLocationName}!`;
            adventureListUI.innerHTML = '';
            const countryAdventures = adventures[selectedLocationName] || [];
            const unlockedCount = gameState.unlockedAdventures[selectedLocationName] || 0;
            const completed = gameState.completedAdventures[selectedLocationName] || [];

            countryAdventures.forEach((adventure, index) => {
                const isUnlocked = index < unlockedCount;
                const isCompleted = completed.includes(index);
                const item = document.createElement('div');
                item.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
                
                let titleHTML = `<span class="text-lg ${isUnlocked ? 'text-white' : 'text-gray-500'}">${adventure.title}</span>`;
                if(isCompleted) {
                    titleHTML += `<span class="ml-4 text-green-400 font-semibold text-sm">✓ Completed</span>`;
                }

                let buttonHTML;
                if(isCompleted) {
                    buttonHTML = `<button class="clickable bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg" onclick="startAdventure(${index})">Revisit Adventure</button>`;
                } else if (isUnlocked) {
                    buttonHTML = `<button class="clickable bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg" onclick="startAdventure(${index})">Start Adventure</button>`;
                } else {
                    buttonHTML = `<button class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" disabled>Locked</button>`;
                }
                
                item.innerHTML = `<div>${titleHTML}</div><div>${buttonHTML}</div>`;
                adventureListUI.appendChild(item);
            });
            
            mainUI.classList.add('hidden');
            levelPage.classList.remove('hidden');
        }

        function startAdventure(adventureIndex) {
            selectedAdventureIndex = adventureIndex;
            currentSceneIndex = 0;
            displayCurrentScene();
            levelPage.classList.add('hidden');
            scenePage.classList.remove('hidden');
        }

        function displayCurrentScene() {
            flipCardInner.classList.remove('is-flipped'); // Reset card flip
            const adventure = adventures[selectedLocationName][selectedAdventureIndex];
            const sceneData = adventure.scenes[currentSceneIndex];
            
            sceneAdventureTitleUI.textContent = adventure.title;
            scenePromptUI.textContent = sceneData.prompt;
            sceneImageUI.src = sceneData.image;
            sceneImageUI.classList.remove('scene-image-animation');
            void sceneImageUI.offsetWidth;
            sceneImageUI.classList.add('scene-image-animation');
            
            sceneOptionsUI.innerHTML = '';
            sceneData.options.forEach((option) => {
                const card = document.createElement('div');
                card.className = 'flex flex-col';
                const button = document.createElement('button');
                button.className = 'clickable bg-blue-600 hover:bg-blue-500 p-4 rounded-lg text-left transition-colors break-words flex-grow flex items-center justify-center';
                button.innerHTML = `<span class="text-center">${option.text}</span>`;
                button.onclick = () => handleOptionClick(option, card);
                const translation = document.createElement('p');
                translation.className = 'text-center text-yellow-400 mt-2 h-6 invisible';
                translation.textContent = option.translation;
                card.appendChild(button);
                card.appendChild(translation);
                sceneOptionsUI.appendChild(card);
            });

            sceneActionsUI.classList.add('hidden');
        }
        
        function showProgressTracker() {
            badgeModal.classList.add('hidden');
            scenePage.classList.add('hidden');
            levelPage.classList.add('hidden');
            mainUI.classList.add('hidden');
            progressPage.classList.remove('hidden');

            // Calculate and display rank
            let completedCountries = 0;
            for (const country of countryOrder) {
                const completedAdventuresInCountry = gameState.completedAdventures[country]?.length || 0;
                const totalAdventuresInCountry = adventures[country]?.length || 0;
                if (totalAdventuresInCountry > 0 && completedAdventuresInCountry >= totalAdventuresInCountry) {
                    completedCountries++;
                }
            }
            const rankIndex = Math.min(completedCountries, ranks.length - 1);
            document.getElementById('current-rank').textContent = ranks[rankIndex];

            const badgeGrid = document.getElementById('badge-grid');
            badgeGrid.innerHTML = '';

            const allBadges = [];
            for (const country in adventures) {
                adventures[country].forEach(adv => {
                    if (adv.badge) {
                        allBadges.push({ name: adv.badge, country: country });
                    }
                });
            }

            allBadges.forEach(badge => {
                const hasBadge = gameState.badges.includes(badge.name);
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg flex flex-col items-center gap-2 text-center ${hasBadge ? 'bg-gray-700' : 'bg-gray-800 opacity-60'}`;
                
                const iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" clip-rule="evenodd" /></svg>`;
                
                card.innerHTML = `
                    <div class="${hasBadge ? 'text-yellow-400' : 'text-gray-500'}">${iconSVG}</div>
                    <h3 class="font-bold">${badge.name}</h3>
                    <p class="text-sm text-gray-400">${badge.country}</p>
                    ${!hasBadge ? '<p class="text-xs font-semibold mt-auto">LOCKED</p>' : ''}
                `;
                badgeGrid.appendChild(card);
            });
        }


        function returnToGlobe() { levelPage.classList.add('hidden'); mainUI.classList.remove('hidden'); }
        function returnToAdventureList() { scenePage.classList.add('hidden'); showAdventureList(); }

        // --- Gameplay Logic ---
        function handleOptionClick(option, clickedCard) {
            const clickedButton = clickedCard.querySelector('button');
            const translationP = clickedCard.querySelector('p');

            if (option.correct) {
                sceneOptionsUI.querySelectorAll('button').forEach(btn => btn.disabled = true);
                sceneOptionsUI.querySelectorAll('p').forEach(p => p.classList.remove('invisible'));
                clickedButton.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                clickedButton.classList.add('bg-green-500');
                sceneActionsUI.classList.remove('hidden');
                const totalScenes = adventures[selectedLocationName][selectedAdventureIndex].scenes.length;
                if (currentSceneIndex < totalScenes - 1) {
                    continueBtn.textContent = `Continue Touring (${currentSceneIndex + 1}/${totalScenes} Scenes)`;
                } else {
                    continueBtn.textContent = 'Complete Adventure';
                }
            } else {
                clickedButton.disabled = true;
                clickedButton.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                clickedButton.classList.add('bg-red-500', 'shake');
                translationP.classList.remove('invisible');
                setTimeout(() => {
                    if (sceneActionsUI.classList.contains('hidden')) { // Only reset if correct answer hasn't been found
                        clickedButton.disabled = false;
                        clickedButton.classList.remove('bg-red-500', 'shake');
                        clickedButton.classList.add('bg-blue-600', 'hover:bg-blue-500');
                        translationP.classList.add('invisible');
                    }
                }, 1500);
            }
        }

        function continueToNextScene() {
            const adventure = adventures[selectedLocationName][selectedAdventureIndex];
            if (currentSceneIndex === adventure.scenes.length - 1) {
                completeAdventure();
            } else {
                currentSceneIndex++;
                displayCurrentScene();
            }
        }
        
        function completeAdventure() {
            const adventure = adventures[selectedLocationName][selectedAdventureIndex];
            const isAlreadyCompleted = gameState.completedAdventures[selectedLocationName]?.includes(selectedAdventureIndex);

            if (!isAlreadyCompleted) {
                gameState.completedAdventures[selectedLocationName].push(selectedAdventureIndex);
                if (!gameState.badges.includes(adventure.badge)) {
                    gameState.badges.push(adventure.badge);
                }
                badgeNameUI.textContent = `${adventure.badge} Badge Unlocked!`;
                badgeModal.classList.remove('hidden');

                const currentUnlockedCount = gameState.unlockedAdventures[selectedLocationName];
                if (selectedAdventureIndex + 1 === currentUnlockedCount) {
                    gameState.unlockedAdventures[selectedLocationName]++;
                }
                if (gameState.unlockedAdventures[selectedLocationName] > adventures[selectedLocationName].length) {
                    const countryIdx = countryOrder.indexOf(selectedLocationName);
                    if (countryIdx < countryOrder.length - 1) {
                        const nextCountry = countryOrder[countryIdx + 1];
                        if (!gameState.unlockedCountries.includes(nextCountry)) {
                            gameState.unlockedCountries.push(nextCountry);
                            gameState.unlockedAdventures[nextCountry] = 1;
                        }
                    }
                }
            } else {
                returnToAdventureList();
            }
        }
        
        // --- Globe Interaction ---
        function getMousePosition(e) { return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY }; }
        function onPointerStart(e) { isDragging = true; container.classList.add('grabbing'); const p = getMousePosition(e); previousMousePosition = { x: p.x, y: p.y }; }
        function onPointerMove(e) { if (!isDragging || isZooming || !globe) return; const p = getMousePosition(e); globe.rotation.y += (p.x - previousMousePosition.x) * 0.005; globe.rotation.x += (p.y - previousMousePosition.y) * 0.005; previousMousePosition = { x: p.x, y: p.y }; }
        function onPointerEnd() { isDragging = false; container.classList.remove('grabbing'); }
        function onObjectClick(e) { if (Math.abs(previousMousePosition.x - e.clientX) > 2 || Math.abs(previousMousePosition.y - e.clientY) > 2) return; mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = - (e.clientY / window.innerHeight) * 2 + 1; raycaster.setFromCamera(mouse, camera); const intersects = raycaster.intersectObjects(clickableObjects); if (intersects.length > 0 && intersects[0].object.userData.isUnlocked) { toggleZoom(intersects[0].object, intersects[0].object.userData.locationName); } }
        function toggleZoom(targetObject, locationName) { isZooming = true; isZoomedIn = !isZoomedIn; locationInfo.classList.add('hidden'); if (isZoomedIn) { instructionText.textContent = "Click the marker again to zoom out."; const p = new THREE.Vector3(); targetObject.getWorldPosition(p); cameraTargetPosition.copy(p.normalize().multiplyScalar(5)); selectedLocationName = locationName; locationNameUI.textContent = locationName; } else { instructionText.textContent = "Drag the globe to explore and click a marker to select a destination."; cameraTargetPosition.copy(originalCameraPosition); selectedLocationName = ''; } }

        // --- Main Loop & Resize ---
        function animate() {
            requestAnimationFrame(animate);
            if (globe && !isDragging && !isZooming && !isZoomedIn) { globe.rotation.y += 0.001; }
            if (stars) { stars.rotation.y += 0.0001; }
            if (isZooming) {
                camera.position.lerp(cameraTargetPosition, 0.05);
                camera.lookAt(scene.position);
                if (camera.position.distanceTo(cameraTargetPosition) < 0.01) {
                    isZooming = false;
                    camera.position.copy(cameraTargetPosition);
                    if (isZoomedIn) { locationInfo.classList.remove('hidden'); }
                }
            }
            renderer.render(scene, camera);
        }
        function onWindowResize() { const w = container.clientWidth, h = container.clientHeight; camera.aspect = w / h; camera.updateProjectionMatrix(); renderer.setSize(w, h); }

        window.onload = function() { try { init(); animate(); } catch (e) { console.error("Three.js initialization failed:", e); } };
    </script>
</body>
</html>

